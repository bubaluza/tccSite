<!doctype html>
<html lang="br">
<head>
    <style>
        a:disabled{
            cursor: not-allowed;
        }
       .sidebar a:hover{
            background: aliceblue;
        }
    </style>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title>TCC</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
            integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous"></script>
    <script src="node_modules/chart.js/dist/chart.js"></script>
    <script src="node_modules/mathjs/dist/math.min.js"></script>
<!--    <script src="https://cdn.anychart.com/releases/v8/js/anychart-base.min.js?hcode=c11e6e3cfefb406e8ce8d99fa8368d33"></script>-->
<!--    <script src="https://cdn.anychart.com/releases/v8/js/anychart-ui.min.js?hcode=c11e6e3cfefb406e8ce8d99fa8368d33"></script>-->
<!--    <script src="https://cdn.anychart.com/releases/v8/js/anychart-exports.min.js?hcode=c11e6e3cfefb406e8ce8d99fa8368d33"></script>-->
<!--    <link href="https://cdn.anychart.com/releases/v8/css/anychart-ui.min.css?hcode=c11e6e3cfefb406e8ce8d99fa8368d33"-->
<!--          type="text/css" rel="stylesheet">-->
<!--    <link href="https://cdn.anychart.com/releases/v8/fonts/css/anychart-font.min.css?hcode=c11e6e3cfefb406e8ce8d99fa8368d33"-->
<!--          type="text/css" rel="stylesheet">-->
</head>

<body>
<!-- Loader -->
<div id="loader" style="position: fixed;
                top: 0;
                width: 100%;
                height: 100%;
                background: gray;
                z-index: 1000;
                opacity: 0.5;
                display: none;">
    <div class="progress">
        <div class="progress-bar progress-bar-striped progress-bar-animated " id="progresso" role="progressbar" style="width: 0%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
</div>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">Análise de Placas Solares</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText"
            aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
    </button>
</nav>

<!--Container-->
<div class="container-fluid">

    <div class="row">

        <!--Sidebar-->
        <nav class="col-md-1  d-md-block bg-light sidebar" style="padding: 0;">
            <div class="sidebar-sticky">
                <ul class="nav flex-column">
                    <li class="nav-item" >
                        <a class="nav-link active disabled" id="atualizar" href="#">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="feather feather-home">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                            Analisar
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!--Content-->
        <main role="main" class="col-md-11 ml-sm-auto col-lg-11 pt-3 px-4">
            <div class="alert alert-danger" id="usb_falha" role="alert"style="display: none">
                A conexão com a USB <strong>FALHOU</strong>. Recoloque  a USB e reinicie o servidor.
            </div>
            <div class="alert alert-success" id="usb_sucesso"  role="alert" style="display: none">
                USB conectada com Sucesso.
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <!--                <div class="chartjs-size-monitor">-->
            <!--                    <div class="chartjs-size-monitor-expand"-->
            <!--                         style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">-->
            <!--                        <div style="position:absolute;width:100000px;height:1000000px;left:0;top:0"></div>-->
            <!--                    </div>-->
            <!--                    <div class="chartjs-size-monitor-shrink"-->
            <!--                         style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">-->
            <!--                        <div style="position:absolute;width:200%;height:200%;left:0; top:0"></div>-->
            <!--                    </div>-->
            <!--                </div>-->

            <h2>Gráficos</h2>
<!--            <div class="row">-->
<!--                <div class="col-sm-12 col-md-6 text-center">-->
<!--                    <div id="graph-1" style="height: 400px"></div>-->
<!--                    <br>-->
<!--                    <button class="btn btn-sm btn-outline-secondary">Export</button>-->
<!--                </div>-->
<!--                <div class="col-sm-12 col-md-6 text-center">-->
<!--                    <div id="graph-2" style="height: 400px"></div>-->
<!--                    <br>-->
<!--                    <button class="btn btn-sm btn-outline-secondary">Export</button>-->
<!--                </div>-->
<!--            </div> -->
            <div class="row">
                <div class="col-sm-12 col-md-6 text-center">
                    <canvas id="chart-1" width="400"></canvas>
                    <br>
                    <button class="btn btn-sm btn-outline-secondary">Exportar CSV</button>
                </div>
                <div class="col-sm-12 col-md-6 text-center">
                    <canvas id="chart-2" width="400"></canvas>
                    <br>
                    <button class="btn btn-sm btn-outline-secondary">Exportar CSV</button>
                </div>
            </div>

            <h2>Análise</h2>

            <div>
                <div class="row">
                    <div class="col-sm-12 col-md-3">
                        <div class="form-group">
                            <label for="maxima_potencia">Máxima Potência</label>
                            <input id="maxima_potencia" type="text" readonly class="form-control">
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-3">
                        <div class="form-group">
                            <label for="tensao_maxima_potencia">Tensão de Máxima Potência</label>
                            <input id="tensao_maxima_potencia" type="text" readonly class="form-control">
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-3">
                        <div class="form-group">
                            <label for="corrente_maxima_potencia">Corrente de Máxima Potência</label>
                            <input type="text" readonly id="corrente_maxima_potencia" class="form-control">
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-3">
                        <div class="form-group">
                            <label for="corrente_cc">Corrente de Curto-Circuito</label>
                            <input type="text" readonly id="corrente_cc" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12 col-md-3">
                        <div class="form-group">
                            <label for="tensao_ca">Tensão de Circuito aberto</label>
                            <input type="text" readonly id="tensao_ca" class="form-control">
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-3">
                        <div class="form-group">
                            <label for="rs">Resistência em Serie</label>
                            <input type="text" readonly id="rs" class="form-control">
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-3">
                        <div class="form-group">
                            <label for="rp">Resistência em Paralelo</label>
                            <input type="text" readonly id="rp" class="form-control">
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-3">
                        <div class="form-group">
                            <label for="cd">Capacitância de Difusão</label>
                            <input type="text" readonly id="cd" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
<script type="text/javascript">
    var csvEstatico;
    var csvDinamico;
    $(document).ready(function() {
        $.ajax({
            type: 'get',
            url: '/ajaxConecao',
            success: (response) => {
                if(!response.conexao){
                    $("#usb_falha").show('1000');
                }else{
                    $("#usb_sucesso").show('1000');
                    $("#atualizar").removeClass('disabled');
                    setTimeout(function () {
                        $("#usb_sucesso").fadeOut('1000');
                    }, 5000);
                }
            },
            error: (response) => {
                console.log(response)
            }
        });
    });

        $('#atualizar').click(function () {
            $('#progresso').css('width', '0%');
            $('#loader').fadeIn(1000);
            $.ajax({
                type: 'get',
                url: '/ajaxSet',
                success: (response) => {
                    interval = setInterval(verificaResposta, 200);
                },
                error: (response) => {
                    console.log(response)
                }
            });
        });

    var ctx1 = $('#chart-1');
    var ctx2 = $('#chart-2');

    var estatico = new Chart(ctx1, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'IV',
                yAxisID: 'corrente',
                backgroundColor: '#003bff',
                data: [{
                    x: 1,
                    y: 100e-3
                },{
                    x:3,
                    y:220e-3
                }]
            },{
                label: 'Potencia',
                yAxisID: 'potencia',
                backgroundColor: 'red',
                data: [{
                    x: 4,
                    y: 11
                },{
                    x: 9,
                    y:0
                }]
            }],

        },
        options: {
            tooltips: {
                callbacks: {
                    title: function(tooltipItem, data) {
                        // console.log(tooltipItem);
                        // console.log(data);
                        return data['datasets'][tooltipItem[0].datasetIndex].label;
                    },
                    label: function(tooltipItem, data) {
                        let x = parseFloat((tooltipItem.label)).toFixed(4);
                        return x+' V';
                    },
                    afterLabel: function(tooltipItem, data) {
                        let y;
                        if (tooltipItem.datasetIndex == 0){
                            y = math.format(parseFloat((tooltipItem.value)),{notation: 'engineering', precision: 4});
                            y = y+' A';
                        }else{
                            y = math.format(parseFloat((tooltipItem.value)),{notation: 'engineering', precision: 4});
                            y = y+' W';
                        }
                        return y;
                    }
                },
                backgroundColor: '#000000',
                titleFontSize: 14,
                titleFontColor: '#ffeb00',
                bodyFontColor: '#08f86d',
                bodyFontSize: 12,
                displayColors: false
            },
            title: {
                display: true,
                text: 'IV'
            },
            scales: {
                yAxes: [{
                    type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                    display: true,
                    position: 'left',
                    id: 'corrente',
                    ticks: {
                        beginAtZero: true
                    },
                    scaleLabel: {
                        display: true,
                        labelString: 'Corrente (A)'
                    }
                }, {
                    type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                    display: true,
                    position: 'right',
                    id: 'potencia',
                    ticks: {
                        beginAtZero: true
                    },
                    scaleLabel: {
                        display: true,
                        labelString: 'Potência (W)'
                    },

                }],
                xAxes: [{
                    type: 'linear',
                    display: true,
                    position: 'bottom',
                    ticks: {
                        beginAtZero: true
                    },
                    scaleLabel: {
                        display: true,
                        labelString: 'Tensão (V)'
                    }
                }]
            }
        }
    });

    var dinamico = new Chart(ctx2, {
        type: 'line',
        data: {
            datasets: [{
                label: 'dinâmico',
                borderColor: '#9e00ff',
                backgroundColor: '#d60cff',
                lineTension: 0,
                fill: false,
                data: [{
                    x: 4,
                    y: 11
                },{
                    x: 9,
                    y:0
                }]
            }]
        },
        options: {
            tooltips: {
                callbacks: {
                    title: function(tooltipItem, data) {
                        return data['datasets'][tooltipItem[0].datasetIndex].label;
                    },
                    label: function(tooltipItem, data) {
                        let x = parseFloat((tooltipItem.label)).toFixed(0);
                        return x+' uS';
                    },
                    afterLabel: function(tooltipItem, data) {
                        let y = parseFloat((tooltipItem.value)).toFixed(4)+' V'
                        return y;
                    }
                },
                backgroundColor: '#000000',
                titleFontSize: 14,
                titleFontColor: '#ffeb00',
                bodyFontColor: '#08f86d',
                bodyFontSize: 12,
                displayColors: false
            },
            title: {
                display: true,
                text: 'Dinâmico'
            },
            scales: {
                xAxes: [{
                    type: 'linear',
                    position: 'bottom',
                    id: 'dinamico',
                    ticks: {
                        beginAtZero: true
                    },
                    scaleLabel: {
                        display: true,
                        labelString: 'Tempo (uS)'
                    }
                }],
                yAxes: [{
                    type: 'linear',
                    position: 'bottom',
                    ticks: {
                        beginAtZero: true
                    },
                    scaleLabel: {
                        display: true,
                        labelString: 'Tensão (V)'
                    }
                }]
            }
        }
    });



    function verificaResposta() {
        $.ajax({
            type: 'get',
            url: '/ajaxMain',
            success: (response) => {
                if (response.erro) {
                    $('#loader').fadeOut(1000);
                    alert("Houve um erro.");
                    clearInterval(interval);
                } else if (!response.chegou) {
                    $('#resposta').val(response.progresso);
                    $('#progresso').css('width', response.progresso + '%');
                    return;
                } else if(response.chegou){

                    var dadosIv = response.dadosIv.map(function (d) {
                        var t = {};
                        t.x= d.voltage;
                        t.y= d.current;
                        return t;
                    });
                    var dadosPot = response.pot.map(function (d) {
                        var t = {};
                        t.x= d.voltage;
                        t.y= d.power;
                        return t;
                    });
                    var dadosDin = response.din.map(function (d) {
                        var t = {};
                        t.x= d.time;
                        t.y= d.voltage;
                        return t;
                    });
                    estatico.data.datasets[0].data = dadosIv;
                    estatico.data.datasets[1].data = dadosPot;
                    dinamico.data.datasets[0].data = dadosDin;
                    estatico.update();
                    dinamico.update();
                    $('#maxima_potencia').val(math.format(response.maxima_potencia,{precision: 4})+' W');
                    $('#tensao_maxima_potencia').val(math.format(response.tensao_maxima_potencia,{precision: 4})+' V');
                    $('#corrente_maxima_potencia').val(math.format(response.corrente_maxima_potencia,{notation: 'engineering', precision: 4})+' A');
                    $('#corrente_cc').val(math.format(response.corrente_cc,{notation: 'engineering', precision: 4})+' A');
                    $('#tensao_ca').val(math.format(response.tensao_ca,{precision: 4})+' V');
                    $('#rs').val(math.format(response.rs,{precision: 4})+' Ω');
                    $('#rp').val(math.format(response.rp,{ precision: 4})+' Ω');
                    $('#cd').val(math.format(response.cd,{notation: 'engineering', precision: 4})+' F')
                    clearInterval(interval);
                    $('#loader').fadeOut(1000);
                }
            },
            error: (response) => {
                console.log(response);
            }
        })
    }
</script>
</body>
</html>
